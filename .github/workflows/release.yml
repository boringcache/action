name: Release Action

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release Action
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.release_meta.outputs.release_tag }}

    steps:
      - name: Determine release tag
        id: release_meta
        run: |
          tag_input="${{ github.event.inputs.tag }}"
          ref="${GITHUB_REF:-}"

          if [ -n "$tag_input" ]; then
            tag="$tag_input"
          elif [ "${ref#refs/tags/}" != "$ref" ]; then
            tag="${ref#refs/tags/}"
          else
            echo "This workflow must be triggered from a tag or provided a tag input." >&2
            exit 1
          fi

          echo "Using release tag: $tag"
          echo "RELEASE_TAG=$tag" >> "$GITHUB_ENV"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Test action
        run: npm test

      - name: Verify package version matches tag
        run: |
          tag="${RELEASE_TAG}"
          pkg_version=$(node -p "require('./package.json').version")
          expected="v${pkg_version}"
          if [ "$expected" != "$tag" ]; then
            echo "Tag $tag does not match package.json version $pkg_version (expected $expected)" >&2
            exit 1
          fi

      - name: Create package archive
        run: |
          # Create release package
          mkdir -p release-package

          # Copy action files
          cp -r dist/ release-package/
          cp action.yml release-package/
          cp README.md release-package/
          cp LICENSE release-package/
          cp package.json release-package/

          # Create version info
          echo "ACTION_VERSION=${RELEASE_TAG}" > release-package/VERSION

          # Create archive
          cd release-package
          tar -czf ../release-package.tar.gz .
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "BoringCache Action ${{ env.RELEASE_TAG }}"
          body: |
            **Cache once. Reuse everywhere.**

            A universal build cache for CI, Docker, and local dev. Reuse what you already builtâ€”without re-uploading.

            Drop-in replacement for `actions/cache` with portable, verified archives.

            See [README](https://github.com/boringcache/action) for usage and migration guide.
          draft: false
          prerelease: false
          files: ./release-package.tar.gz
